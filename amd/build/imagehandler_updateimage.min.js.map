{"version":3,"sources":["../src/imagehandler_updateimage.js"],"names":["define","$","Repository","CustomEvents","Cropworker","addCoverImageAlert","target","id","msg","closestr","M","util","get_string","length","find","before","humanFileSize","size","i","Math","floor","log","pow","toFixed","cleanState","removeClass","remove","state1","addClass","state2","state3","coverImage","siteMaxBytes","ajaxParams","data","css","file","filedata","events","activate","on","e","originalImage","attr","width","height","croppedImage","enableExif","viewport","type","bind","url","resultBtn","result","then","imageData","imagedata","split","imagefilename","cropped","saveImage","params","success","destroy","location","reload","cancelBtn","preventDefault","files","match","reader","FileReader","onload","theFile","maxbytes","maxbytesstr","message","img","get","src","name","readAsDataURL","click","parent","hasClass","fileurl","updateImage","imageid"],"mappings":"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","sourcesContent":["/**\n * This file is part of Moodle - http://moodle.org/\n *\n * Moodle is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Moodle is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @package   theme_imagehandler\n * @copyright Copyright (c) 2015 Blackboard Inc. (http://www.blackboard.com)\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(\n[\n    'jquery',\n    'theme_nova/repository',\n    'core/custom_interaction_events',\n    'theme_arupboost/imagehandler_cropworker'\n],\nfunction(\n    $,\n    Repository,\n    CustomEvents,\n    Cropworker\n) {\n\n    var addCoverImageAlert = function(target, id, msg) {\n        var closestr = M.util.get_string('closebuttontitle', 'moodle');\n        if (!$(id).length) {\n            target.find('#uploadbutton').before(\n                '<div id=\"' + id + '\" class=\"alert alert-warning state-element state1\" role=\"alert\">' +\n                msg +\n                '<button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"' + closestr + '\">' +\n                '<span aria-hidden=\"true\">&times;</span>' +\n                '</button>' +\n                '</div>'\n            );\n        }\n    };\n\n    /**\n     * Get human file size from bytes.\n     * http://stackoverflow.com/questions/10420352/converting-file-size-in-bytes-to-human-readable.\n     * @param {int} size\n     * @returns {string}\n     */\n    var humanFileSize = function(size) {\n        var i = Math.floor(Math.log(size) / Math.log(1024));\n        return (size / Math.pow(1024, i)).toFixed(2) * 1 + ' ' + ['B', 'kB', 'MB', 'GB', 'TB'][i];\n    };\n\n    var cleanState = function(target) {\n        target.removeClass('state0');\n        target.removeClass('state1');\n        target.removeClass('state2');\n        target.removeClass('state3');\n        target.removeClass('state4');\n        target.find('[role=\"alert\"]').remove();\n    };\n\n    /**\n     * First state - image selection button visible.\n     */\n    var state1 = function(target) {\n        cleanState(target);\n        target.addClass('state1');\n        // TODO find a more elegant way to fix this.\n    };\n\n    /**\n     * Second state - confirm / cancel buttons visible.\n     */\n    var state2 = function(target) {\n        cleanState(target);\n        target.addClass('state2');\n    };\n\n    /**\n     * Third state - crop actions visible.\n     */\n    var state3 = function(target) {\n        cleanState(target);\n        target.addClass('state3');\n    };\n\n    /**\n     *\n     * @param {int} siteMaxBytes\n     * @param {object} ajaxParams\n     */\n    var coverImage = function(target, siteMaxBytes, ajaxParams) {\n        // Take a backup of what the current background image url is (if any).\n        target.data('servercoverfile', target.css('background-image'));\n\n        var file,\n            filedata;\n\n        CustomEvents.define(target, [CustomEvents.events.activate]);\n        target.on(\n            CustomEvents.events.activate,\n            '[data-action=\"cropimage\"]',\n            function(e) {\n\n                // Hide elements in the container when cropping.\n                state3(target);\n\n                // For image cropping we need a real <img> in the container.\n                var originalImage = target.attr('data-original');\n\n                var width = (target.width() / 100) * (90);\n                var height = (target.height() / 100) * (90);\n\n                // Cropy wants the native DOM element so using target[0].\n                var croppedImage = new Cropworker(target[0], {\n                    enableExif: true,\n                    viewport: {\n                        width: width,\n                        height: height,\n                        type: 'square'\n                    }\n                });\n                croppedImage.bind({\n                    url: originalImage,\n                });\n\n                var resultBtn = target.find('[data-action=\"crop-confirm\"]');\n                resultBtn.on('click', function() {\n                    croppedImage.result('base64').then(function(imageData) {\n\n                        ajaxParams.imagedata = imageData.split('base64,')[1];\n                        ajaxParams.imagefilename = originalImage;\n                        ajaxParams.cropped = 1;\n\n                        Repository.saveImage({params: ajaxParams}).then(function(result) {\n                            if (result.success) {\n                                state1(target);\n                                target.css('background-image', 'url(' + imageData + ')');\n                                croppedImage.destroy();\n                                location.reload();\n                            }\n                        });\n\n                    });\n                });\n                var cancelBtn = target.find('[data-action=\"crop-cancel\"]');\n                cancelBtn.on('click', function() {\n                    croppedImage.destroy();\n                    state1(target);\n                });\n                e.preventDefault();\n            }\n        );\n\n        target.find('.input-coverfiles').on('change',\n            function(e) {\n                var files = e.target.files; // FileList object.\n                if (!files.length) {\n                    return;\n                }\n\n                file = files[0];\n\n                // Only process image files.\n                if (!file.type.match('image.*')) {\n                    return;\n                }\n\n                var reader = new FileReader();\n\n                target.find('label[for=\"imagehandler-coverfiles\"]').addClass('ajaxing');\n\n                // Closure to capture the file information.\n                reader.onload = (function(theFile) {\n                    return function(e) {\n\n                        // Set page header to use local version for now.\n                        filedata = e.target.result;\n\n                        // Warn if image file size exceeds max upload size.\n                        // Note: The site max bytes is intentional, as the person who can do the upload would be able to\n                        // override the course upload limit anyway.\n                        var maxbytes = siteMaxBytes;\n\n                        if (theFile.size > maxbytes) {\n                            // Go back to initial state and show warning about image file size.\n                            state1(target);\n                            var maxbytesstr = humanFileSize(maxbytes);\n                            var message = M.util.get_string('error:coverimageexceedsmaxbytes', 'theme_arupboost', maxbytesstr);\n                            addCoverImageAlert(target, 'imagehandler-alert-cover-image-bytes', message);\n                            return;\n                        } else {\n                            target.find('#imagehandler-alert-cover-image-bytes').remove();\n                        }\n\n                        // Warn if image resolution is too small.\n                        var img = $('<img />');\n                        img = img.get(0);\n                        img.src = filedata;\n                        $(img).on('load', function() {\n                            if (img.width < 400) {\n                                addCoverImageAlert(target, 'imagehandler-alert-cover-image-size',\n                                    M.util.get_string('error:coverimageresolutionlow', 'theme_arupboost')\n                                );\n                            } else {\n                                target.find('#imagehandler-alert-cover-image-size').remove();\n                            }\n                        });\n\n                        target.css('background-image', 'url(' + filedata + ')');\n                        target.data('localcoverfile', theFile.name);\n\n                        state2(target);\n                    };\n                })(file);\n\n                // Read in the image file as a data URL.\n                reader.readAsDataURL(file);\n            }\n        );\n\n        target.find('#imagehandler-changecoverimageconfirmation .ok').click(function(e) {\n\n            if ($(this).parent().hasClass('disabled')) {\n                return;\n            }\n\n            e.preventDefault();\n\n            target.find('#imagehandler-alert-cover-image-size').remove();\n            target.find('#imagehandler-alert-cover-image-bytes').remove();\n\n            target.find('#imagehandler-changecoverimageconfirmation .ok').addClass('ajaxing');\n            target.find('#imagehandler-changecoverimageconfirmation').addClass('disabled');\n\n            var imageData = filedata.split('base64,')[1];\n\n            ajaxParams.imagedata = imageData;\n            ajaxParams.imagefilename = file.name;\n            ajaxParams.cropped = 0;\n\n            Repository.saveImage({params: ajaxParams}).then(function(result) {\n                if (result.success) {\n                    state1(target);\n                    target.attr('data-original', result.fileurl);\n                    location.reload();\n                }\n            });\n\n        });\n        target.find('#imagehandler-changecoverimageconfirmation .cancel').click(function() {\n            if ($(this).parent().hasClass('disabled')) {\n                return;\n            }\n\n            target.css('background-image', target.data('servercoverfile'));\n            state1(target);\n        });\n        target.find('.uploadimagecontrols').addClass('imagehandler-js-enabled');\n    };\n\n    var updateImage = function(target, siteMaxBytes) {\n        var ajaxParams = {\n            imagefilename: null,\n            imagedata: null,\n            imageid: target.attr('data-imageid'),\n            type: target.attr('data-type')\n        };\n        coverImage(target, siteMaxBytes, ajaxParams);\n    };\n\n    return {\n        updateImage: updateImage\n    };\n});\n"],"file":"imagehandler_updateimage.min.js"}